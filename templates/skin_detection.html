{% extends 'root/base.html' %}
{% block content %}
<head>
  <style>
    .hidden {
      display: none;
    }
  </style>
</head>
<div class="page-titles">
  <!-- ... -->
</div>

<!-- ... -->

<div class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="border-bottom title-part-padding">
        <h4 class="mb-0">Deteksi Wajah Anda</h4>
      </div>
      <div class="card-body">
        <h6 class="card-subtitle mb-3">
          Gunakan kamera untuk mendeteksi wajah anda secara realtime.
        </h6>
        <video id="videoElement" width="640" height="480" autoplay></video>
        <canvas id="overlay" width="640" height="480" style="position: absolute; top: 0; left: 0;"></canvas>
        <button id="startDetection" class="btn btn-success mt-2" type="button">Mulai Deteksi</button>
      </div>
    </div>
  </div>
</div>

<!-- ... -->

<script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    async function setupCamera() {
      const video = document.getElementById('videoElement');

      // Dapatkan akses ke webcam
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (error) {
        console.error("Error accessing webcam: ", error);
      }

      // Muat model Face API
      await faceapi.nets.tinyFaceDetector.loadFromUri('/static/models');

      video.addEventListener('play', () => {
        const canvas = document.getElementById('overlay');
        const displaySize = { width: video.width, height: video.height };
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
          const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
          const resizedDetections = faceapi.resizeResults(detections, displaySize);
          canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
          faceapi.draw.drawDetections(canvas, resizedDetections);

          // Hitung jarak berdasarkan bounding box
          if (resizedDetections.length > 0) {
            const box = resizedDetections[0].detection.box;
            const faceSize = box.width * box.height;
            console.log(`Face size: ${faceSize}`);
          }
        }, 100);
      });
    }

    setupCamera();
  });
</script>

{% endblock %}
